<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Generate for Movies</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;700&family=Montserrat:wght@900&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #e9ecef;
            font-family: 'Figtree', sans-serif;
            color: #212529;
        }
        
        .main-container { margin-top: 50px; margin-bottom: 50px; }
        .card { border: none; box-shadow: 0 6px 24px rgba(0,0,0,0.09); border-radius: 16px; }
        .card-body { padding: 2rem; }
        .form-label { font-weight: 700; margin-bottom: 0.5rem; }
        .btn-primary, .btn-success { padding: 0.8rem 1.5rem; border-radius: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Style Editor */
        #editor-container {
            height: 150px;
            background-color: white;
            font-family: 'Figtree', sans-serif;
        }
        .ql-toolbar.ql-snow {
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            background-color: #f8f9fa;
        }
        .ql-container.ql-snow {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            font-size: 1rem;
        }

        #downloadable-content {
            width: 1080px; height: 1920px; overflow: hidden;
            background-color: #111; background-size: cover; background-position: center center;
            display: flex; flex-direction: column; justify-content: flex-end;
            position: absolute; left: -9999px; top: -9999px; z-index: -1; 
        }

        #downloadable-content::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 35%, rgba(0,0,0,0) 65%); z-index: 1;
        }

        .story-text-content {
            position: relative; z-index: 2; padding: 70px 70px 120px 70px; color: #ffffff;
            display: flex; flex-direction: column; align-items: center; 
        }

        #download-movie-title {
            font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 5.2rem;
            line-height: 1.1; margin-bottom: 25px; text-transform: uppercase; letter-spacing: -2px; text-align: center;
        }

        #download-movie-review {
            font-family: 'Figtree', sans-serif; font-size: 2.0rem; font-weight: 400; color: #e0e0e0;
            line-height: 1.5; margin-bottom: 35px; overflow-wrap: break-word; word-wrap: break-word; text-align: center;
            width: 100%;
        }

        /* Style Formatting Text */
        #download-movie-review strong, #download-movie-review b {
            color: #ffffff;
            font-weight: 800;
        }
        #download-movie-review em, #download-movie-review i {
            color: #d1d1d1;
            font-style: italic;
        }
        #download-movie-review p {
            margin-bottom: 0.5rem;
        }

        #download-movie-rating {
            font-family: 'Montserrat', sans-serif; font-weight: 900; display: inline-block;
            background-color: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 20px 35px; font-size: 2.2rem; margin-bottom: 20px;
        }

        .rating-score { font-size: 2.7rem; font-weight: 900; }

        /* --- PERBAIKAN ALIGNMENT INSTAGRAM --- */
        #download-instagram-link {
            font-family: 'Figtree', sans-serif; 
            font-size: 1.8rem; 
            color: rgba(255, 255, 255, 0.7); 
            text-decoration: none;
            /* Flexbox Settings untuk Center */
            margin-top: 10px; 
            display: inline-flex; 
            align-items: center; /* Kunci agar sejajar vertikal */
            justify-content: center;
            gap: 12px; 
            line-height: 1; /* Reset line-height */
        }
        
        #download-instagram-link svg { 
            width: 28px; 
            height: 28px; 
            fill: currentColor; 
            display: block; /* Menghapus spasi bawaan inline elements */
            /* top: 2px; <- DIHAPUS karena merusak alignment */
        }

        #result-card-visible {
            min-height: 450px; border-radius: 16px; background-color: #111;
            background-size: cover; background-position: center; padding: 1.5rem;
            display: flex; flex-direction: column; justify-content: flex-end;
            position: relative; color: white; text-align: left;
        }
        
        #result-card-visible::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 16px; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 70%);
        }
        
        #preview-content { position: relative; z-index: 2; }
        #preview-content h3 { font-family: 'Montserrat', sans-serif; font-weight: 900; }
    </style>
</head>
<body>

    <div class="container main-container">
        <div class="row g-4 justify-content-center">

            <div class="col-lg-5 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title mb-4 fw-bold">Buat Review Film</h3>
                        
                        <div class="row">
                            <div class="col-md-8 mb-3"> <label for="movieName" class="form-label">Nama Film</label> <input type="text" class="form-control" id="movieName" placeholder="Contoh: F1: The Movie"> </div>
                            <div class="col-md-4 mb-3"> <label for="movieYear" class="form-label">Tahun</label> <input type="number" class="form-control" id="movieYear" placeholder="2025"> </div>
                        </div>

                        <div class="mb-3"> <label for="movieRating" class="form-label">Rating (1-10)</label> <input type="number" class="form-control" id="movieRating" min="1" max="10" value="9"> </div>
                        
                        <div class="mb-3"> 
                            <label class="form-label">Review Singkat (Opsional)</label> 
                            <div id="editor-container"></div>
                        </div>

                        <div class="mb-3"> <label for="instagramHandle" class="form-label">Instagram Handle (Opsional)</label> <input type="text" class="form-control" id="instagramHandle" value="alvadyza" placeholder="Contoh: alvadyza"> </div>

                        <div class="mb-3">
                            <label class="form-label">Sumber Poster</label>
                            <ul class="nav nav-tabs" id="posterSourceTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="single-poster-tab" data-bs-toggle="tab" data-bs-target="#single-poster-pane" type="button">Single Poster</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="grid-poster-tab" data-bs-toggle="tab" data-bs-target="#grid-poster-pane" type="button">3-Grid Poster</button>
                                </li>
                            </ul>
                            <div class="tab-content border border-top-0 p-3 bg-white">
                                <div class="tab-pane fade show active" id="single-poster-pane" role="tabpanel">
                                    <ul class="nav nav-pills mb-3" id="singleImageTypeTab">
                                        <li class="nav-item"> <a class="nav-link active" data-bs-toggle="pill" href="#upload-single">Upload</a> </li>
                                        <li class="nav-item"> <a class="nav-link" data-bs-toggle="pill" href="#url-single">URL</a> </li>
                                    </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane fade show active" id="upload-single"> <input class="form-control" type="file" id="imageUpload" accept="image/*"> </div>
                                        <div class="tab-pane fade" id="url-single"> <input type="text" class="form-control" id="imageUrl" placeholder="https://example.com/poster.jpg"> </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="grid-poster-pane" role="tabpanel">
                                    <div class="mb-2"> <label for="gridImageTop" class="form-label small">Gambar Atas</label> <input class="form-control form-control-sm" type="file" id="gridImageTop" accept="image/*"> </div>
                                    <div class="mb-2"> <label for="gridImageMiddle" class="form-label small">Gambar Tengah</label> <input class="form-control form-control-sm" type="file" id="gridImageMiddle" accept="image/*"> </div>
                                    <div> <label for="gridImageBottom" class="form-label small">Gambar Bawah</label> <input class="form-control form-control-sm" type="file" id="gridImageBottom" accept="image/*"> </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-4"> <button class="btn btn-primary" type="button" id="generateBtn">Generate</button> </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5 col-md-6">
                <div class="card">
                    <div id="result-card-visible"> <div id="preview-content"> <h4 class="placeholder-text fw-normal text-white-50">Preview akan tampil di sini...</h4> </div> </div>
                    <div class="card-footer bg-transparent border-0 p-3" id="download-section" style="display: none;"> <div class="d-grid"> <button class="btn btn-success" type="button" id="downloadBtn">Download Story</button> </div> </div>
                </div>
            </div>
        </div>
    </div>

    <div id="downloadable-content">
        <div class="story-text-content">
            <h1 id="download-movie-title"></h1>
            <div id="download-movie-review"></div>
            <div id="download-movie-rating"></div>
            <a href="#" id="download-instagram-link" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>
                <span id="instagram-username-output"></span>
            </a>
        </div>
    </div>
    
    <canvas id="grid-canvas" style="display: none;"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var quill = new Quill('#editor-container', {
                theme: 'snow',
                placeholder: 'Tulis review... (Bisa Bold & Italic)',
                modules: {
                    toolbar: [
                        ['bold', 'italic'], 
                        ['clean']
                    ]
                }
            });

            const generateBtn = document.getElementById('generateBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadSection = document.getElementById('download-section');
            const movieNameInput = document.getElementById('movieName');
            const movieYearInput = document.getElementById('movieYear');
            const movieRatingInput = document.getElementById('movieRating');
            const instagramHandleInput = document.getElementById('instagramHandle');
            
            const imageUploadInput = document.getElementById('imageUpload');
            const imageUrlInput = document.getElementById('imageUrl');
            const gridImageTopInput = document.getElementById('gridImageTop');
            const gridImageMiddleInput = document.getElementById('gridImageMiddle');
            const gridImageBottomInput = document.getElementById('gridImageBottom');

            const resultCardVisible = document.getElementById('result-card-visible');
            const previewContentContainer = document.getElementById('preview-content');
            const downloadableContent = document.getElementById('downloadable-content');
            const downloadMovieTitle = document.getElementById('download-movie-title');
            const downloadMovieReview = document.getElementById('download-movie-review');
            const downloadMovieRating = document.getElementById('download-movie-rating');
            const downloadInstagramLink = document.getElementById('download-instagram-link');
            const instagramUsernameOutput = document.getElementById('instagram-username-output');
            
            const gridCanvas = document.getElementById('grid-canvas');
            const ctx = gridCanvas.getContext('2d');
            gridCanvas.width = 1080;
            gridCanvas.height = 1920;

            function drawCoverImage(ctx, img, x, y, w, h) {
                const imgRatio = img.width / img.height;
                const containerRatio = w / h;
                let sx, sy, sWidth, sHeight;

                if (imgRatio > containerRatio) { 
                    sHeight = img.height;
                    sWidth = sHeight * containerRatio;
                    sx = (img.width - sWidth) / 2;
                    sy = 0;
                } else { 
                    sWidth = img.width;
                    sHeight = sWidth / containerRatio;
                    sx = 0;
                    sy = (img.height - sHeight) / 2;
                }
                ctx.drawImage(img, sx, sy, sWidth, sHeight, x, y, w, h);
            }

            function loadImage(file) {
                return new Promise((resolve, reject) => {
                    if (!file) { return reject('File tidak ditemukan'); }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            generateBtn.addEventListener('click', async function() {
                const activePosterTab = document.querySelector('#posterSourceTab .nav-link.active');
                let backgroundImageUrl = '';

                try {
                    if (activePosterTab.id === 'grid-poster-tab') {
                        const files = [gridImageTopInput.files[0], gridImageMiddleInput.files[0], gridImageBottomInput.files[0]];
                        if (files.some(f => !f)) {
                            alert('Harap unggah ketiga gambar untuk mode 3-Grid.');
                            return;
                        }

                        const [imgTop, imgMiddle, imgBottom] = await Promise.all(files.map(loadImage));
                        
                        ctx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);
                        drawCoverImage(ctx, imgTop, 0, 0, 1080, 640);
                        drawCoverImage(ctx, imgMiddle, 0, 640, 1080, 640);
                        drawCoverImage(ctx, imgBottom, 0, 1280, 1080, 640);

                        backgroundImageUrl = gridCanvas.toDataURL('image/jpeg');
                    } else {
                        const activeSingleTypeTab = document.querySelector('#singleImageTypeTab .nav-link.active');
                        if (activeSingleTypeTab.getAttribute('href') === '#upload-single' && imageUploadInput.files.length > 0) {
                            backgroundImageUrl = URL.createObjectURL(imageUploadInput.files[0]);
                        } else if (activeSingleTypeTab.getAttribute('href') === '#url-single' && imageUrlInput.value.trim() !== '') {
                            backgroundImageUrl = imageUrlInput.value.trim();
                        }
                    }
                    updateContent(backgroundImageUrl);
                } catch (error) {
                    console.error("Gagal memproses gambar:", error);
                    alert("Terjadi kesalahan saat memuat gambar. Pastikan file valid.");
                }
            });

            function updateContent(imageUrl) {
                const name = movieNameInput.value || "Judul Film";
                const year = movieYearInput.value || new Date().getFullYear();
                const rating = movieRatingInput.value || 7;
                
                // Ambil data dari Quill
                const reviewHTML = quill.root.innerHTML; 
                const reviewText = quill.getText().trim(); 
                
                const instagramHandle = instagramHandleInput.value.trim();

                const backgroundStyle = imageUrl ? `url(${imageUrl})` : 'none';

                let reviewPreviewHTML = reviewText ? `<p class="text-white-50 small">${reviewText.substring(0, 100)}...</p>` : '';
                
                resultCardVisible.style.backgroundImage = backgroundStyle;
                previewContentContainer.innerHTML = `<h3>${name} (${year})</h3> ${reviewPreviewHTML} <h4 class="fw-bold">${rating}/10</h4>`;

                downloadableContent.style.backgroundImage = backgroundStyle;
                downloadMovieTitle.innerHTML = `${name} (${year})`;
                downloadMovieRating.innerHTML = `<span class="rating-score">${rating}</span>/10`;

                if (reviewText.length > 0) {
                    // Masukkan HTML Quill
                    downloadMovieReview.innerHTML = reviewHTML;
                    downloadMovieReview.style.display = 'block';
                } else {
                    downloadMovieReview.style.display = 'none';
                }
                
                if (instagramHandle) {
                    instagramUsernameOutput.textContent = instagramHandle;
                    downloadInstagramLink.href = `https://www.instagram.com/${instagramHandle}/`;
                    downloadInstagramLink.style.display = 'inline-flex';
                } else {
                    downloadInstagramLink.style.display = 'none';
                }

                downloadSection.style.display = 'block';
            }

            downloadBtn.addEventListener('click', function() {
                html2canvas(downloadableContent, {
                    width: 1080, height: 1920, backgroundColor: '#111111',
                    scale: 1, useCORS: true, allowTaint: true
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `review-${movieNameInput.value.replace(/\s+/g, '-').toLowerCase()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            });
        });
    </script>

</body>
</html>
